# 自动评教助手 (ACE) 操作逻辑与流程说明

本文档详细描述了“南理工教务增强助手”中“自动评教助手”模块的核心运行逻辑、跨页面通信机制及自动化流程。

---

## 1. 核心运行机制

自动评教助手采用 **“主控调度 + 详情执行”** 的分布式架构，利用 `localStorage` 实现多窗口间的状态同步和互斥锁控制。

### 1.1 关键状态 (LocalStorage)
- `njust_eval_v1_store`: 核心数据库，记录所有课程的 ID、名称、教师、URL、是否勾选自动化、是否已完成评价等信息。
- `njust_eval_running`: 全局开关，指示是否正在执行“自动填分并保存”的流水线。
- `njust_eval_subrun`: 全局开关，指示是否正在执行“批量提交”的流水线。
- `njust_eval_busy` / `njust_eval_subbsy`: **互斥锁**。确保同一时间只有一个评价详情页在执行自动化动作，防止因网络延迟导致多个窗口同时开启。

---

## 2. 自动化流水线流程

### 2.1 自动填分并保存流程 (Save Pipeline)

1.  **启动**：用户在 `xspj_list.do` 页面点击“开始评价并保存”。
2.  **标记**：系统将 `njust_eval_running` 设为 `true`。
3.  **调度**：
    - 遍历 `store`，寻找第一个 `auto=true` 且 `done=false` 的课程。
    - 若找到，设置 `njust_eval_busy=true`，并在新窗口打开该课程 URL（追加 `isAutoEval=true` 参数）。
4.  **执行 (详情页)**：
    - 页面加载后，脚本识别到 `isAutoEval` 参数。
    - **评分策略**：默认执行 `highest` 策略（全选最高分，并在分值差距最小的题目选次高分以规避全满分拦截）。
    - **自动保存**：调用页面原生的 `saveData` 函数执行保存操作。
    - **完成回调**：保存成功后，更新 `store` 中的 `done=true`，将 `njust_eval_busy` 设为 `false`，并关闭当前窗口。
5.  **循环**：`xspj_list.do` 页面监听 `storage` 事件，一旦发现 `busy` 锁释放，立即触发下一次调度。

### 2.2 批量提交流程 (Submit Pipeline)

1.  **启动**：用户在列表页点击“提交已评课程”。
2.  **队列**：将所有“待提交”状态的课程 URL 存入 `njust_eval_subqueue`。
3.  **调度**：设置 `njust_eval_subrun=true`，从队列中取出一个 URL，设置 `njust_eval_subbsy=true` 并打开详情页（追加 `isAutoSubmit=true` 参数）。
4.  **执行 (详情页)**：
    - 识别到 `isAutoSubmit` 参数，直接调用原生的提交函数。
    - 提交后关闭窗口，释放 `subbsy` 锁。
5.  **循环**：列表页检测到锁释放，继续取出下一个队列项，直到队列清空。

---

## 3. 评分算法与策略

为了规避教务系统的“全满分限制”或“评分雷同”检测，ACE 引入了**智能扰动算法**：

- **最高分策略 (Highest)**：
    - 算法自动计算所有题目的分值梯度（最高分 - 次高分）。
    - 选择梯度最小（即损失分值最少）的那道题，将其选为“次高分”，其余题目全部选为“最高分”。
    - **目的**：在保证总分最高（通常为 99+）的前提下，使选项不全为第一项。
- **手动模式**：
    - 在手动评教页面，脚本会在每个 Radio 选项后实时标注其代表的真实分值。
    - 提供“最高分、中高分、中分、低分”四档快捷填分按钮，方便用户快速填充后自行微调。

---

## 4. 安全保护机制

- **人工确认限制**：由于教务系统在保存/提交时会触发浏览器的 `confirm` 弹窗，受浏览器安全限制，脚本**无法自动点击确认按钮**。
- **手动干预**：用户必须在每个弹出的详情页手动点击“确认”，脚本才能继续关闭窗口并执行下一项。
- **一键重置**：提供“重置缓存”按钮，可清除所有本地存储的状态，用于解决因网络中断导致的流程卡死。

---

## 5. 日志与反馈

- **分级日志**：控制面板底部实时记录 `[INF]`、`[OK ]`、`[WRN]`、`[ERR]` 等不同级别的运行日志。
- **状态看板**：日志面板标题栏实时显示当前正在处理的课程名称或操作状态（如“正在保存：大学英语”），并在闲置 5 秒后自动复位。
