name: Build Docs to Pages

# 移除所有过滤，所有分支的所有 push 操作都触发，同时支持手动触发
on:
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. 检出源码
      - uses: actions/checkout@v4

      # 2. 安装 Pandoc（带重试机制，容错性更强）
      - name: Install Pandoc
        run: |
          for i in 1 2 3; do
            sudo apt-get update && break
            echo "apt update 失败，第 $i 次重试..."
            sleep 2
          done
          sudo apt-get install -y pandoc || { echo "Pandoc 安装失败，请检查 apt 源"; exit 1; }

      # 3. 创建 dist 目录
      - name: Prepare dist directory
        run: mkdir -p dist && echo "dist 目录创建成功"

      # 4. 获取最新 commit 信息（UTC+8 时间）
      - name: Get last commit info
        run: |
          HASH=$(git log -1 --format=%h)
          MSG=$(git log -1 --format=%s)
          DATE=$(TZ="Asia/Shanghai" git log -1 --format=%cd --date=format:'%Y-%m-%d %H:%M:%S')
          cat <<EOF >> $GITHUB_ENV
HASH=$HASH
MSG=$MSG
DATE=$DATE
EOF

      # 5. 批量生成 HTML 并替换 .md 链接
      - name: Build HTML from Markdown
        run: |
          for f in README*.md; do
            [ -f "$f" ] || continue
            if [ "$f" = "README.md" ]; then
              name="index"
            else
              name=$(basename "$f" .md)
            fi
            pandoc "$f" -s -c style.css -o "dist/$name.html"
            echo "已生成 dist/$name.html"
            sed -i.bak 's/\.md"/.html"/g' "dist/$name.html" && rm -f "dist/$name.html.bak"
            sed -i.bak 's/\.md#/.html#/g' "dist/$name.html" && rm -f "dist/$name.html.bak"
            echo "已替换 dist/$name.html 中的 .md 链接"
            cat >> "dist/$name.html" <<EOL
<footer class="auto-footer" style="margin-top:40px;padding-top:20px;border-top:1px solid #d0d7de;font-size:0.9em;color:#57606a;text-align:center;">
<p>Last update: $DATE</p>
<p>Commit: <code>$HASH</code> — $MSG</p>
<p><a href="https://github.com/NJUST-OpenLib/NJUST-JWC-Enhance/commit/$HASH">View on GitHub</a></p>
</footer>
EOL
          done

      # 6. 复制资源文件
      - name: Copy assets to dist
        run: |
          [ -f "style.css" ] && cp style.css dist/ && echo "style.css 已复制到 dist 目录" || echo "style.css 文件不存在，跳过复制"
          [ -d "docs" ] && cp -r docs dist/ && echo "docs 目录已复制到 dist 目录" || echo "docs 目录不存在，跳过复制"

      # 7. 部署到 GitHub Pages
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: dist
          keep_files: false
          commit_message: "docs: deploy from commit ${{ env.HASH }}"
          enable_jekyll: false
